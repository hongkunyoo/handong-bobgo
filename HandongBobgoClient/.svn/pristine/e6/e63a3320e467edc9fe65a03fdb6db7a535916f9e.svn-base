package com.example.bobgo;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import edu.handong.babgo.common.GlobalVariables;
import edu.handong.babgo.model.Message;
import edu.handong.babgo.util.PreferenceHelper;
import edu.handong.babgo.util.RequestHelper;

public class Settings extends Activity {
    String id;
    String pw;
    String pn;
    ProgressDialog progressDialog;
    AlertDialog.Builder ab;
    Dialog dialog;
    Context context;
    PreferenceHelper preHelper;
    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.layout_settings);
        context = this.getApplicationContext();
        preHelper = new PreferenceHelper(context);
	    ImageView iv_id = (ImageView)findViewById(R.id.id_setting);
	    ImageView iv_ap = (ImageView)findViewById(R.id.appointment_setting);
	    
	    iv_id.setOnClickListener(new View.OnClickListener(){
	    	
    		
	    	public void onClick(View v){
	    		
	    		
	    		dialog = new Dialog(Settings.this);
	    		dialog.setContentView(R.layout.layout_dialog);
	    		dialog.setTitle("Information Setting");
	    		EditText et_id = (EditText)dialog.findViewById(R.id.IDedit);
	    		EditText et_pn = (EditText)dialog.findViewById(R.id.PNedit);
	 
	    		Button bt_ok = (Button)dialog.findViewById(R.id.bt_ok);
	    		Button logout = (Button)dialog.findViewById(R.id.bt_cancel);
	    		
	    		
	    		String hisnetId = preHelper.getHisnetId();
	    		String phone = preHelper.getPhone();
	    		if(!(hisnetId.equals("") && phone.equals(""))){
	    			et_id.setHint(hisnetId);
	    			et_pn.setHint(phone);
	    		}
	    		
	    		bt_ok.setOnClickListener(new OnClickListener(){
	    			public void onClick(View v){
	    				EditText et_id = (EditText)dialog.findViewById(R.id.IDedit);
	    	    		EditText et_pw = (EditText)dialog.findViewById(R.id.PWedit);
	    	    		EditText et_pn = (EditText)dialog.findViewById(R.id.PNedit);
	    				id = et_id.getText().toString();
	    				pw = et_pw.getText().toString();
	    				pn = et_pn.getText().toString();
	    				
	    				new SettingsAsyncTask().execute(id,pw,pn);

	    				dialog.dismiss();
	    			}
	    		});
	    		logout.setOnClickListener(new OnClickListener(){
	    			public void onClick(View v){
	    				preHelper.setHisnetId("");
	    				preHelper.setPassword("");
	    				preHelper.setPhone("");
	    				dialog.dismiss();
	    			}
	    		});
	    		
	    		dialog.show();
	    		
	    	}
	    });
	    
	    iv_ap.setOnClickListener(new View.OnClickListener(){
	    	
	    	public void onClick(View v){
		    	Intent i = new Intent(Settings.this, SetScheduleActivity.class);
		    	startActivity(i);
	    	}
	    	
	    });
    
    }
    
    private class SettingsAsyncTask extends AsyncTask<String, String, String>{
    	@Override
    	protected void onPreExecute(){
    		showDialog(0);
    	}
    	
		@Override
		protected String doInBackground(String... params) {
			// TODO Auto-generated method stub
			String hisnetId = params[0];
			String password = params[1];
			String phone = params[2];
			RequestHelper helper = GlobalVariables.getRequestHelper();
			Message m = helper.setAccount(phone, hisnetId, password, 1);
			
			return m.getMessage();
		}
		
		@Override
		protected void onPostExecute(String arg){
			removeDialog(0);
			if(GlobalVariables.SUCCEED.equals(arg)){
				preHelper.setHisnetId(id);
				preHelper.setPassword(pw);
				preHelper.setPhone(pn);
				showDialog(1);
			}else{
				preHelper.setHisnetId("");
				preHelper.setPassword("");
				preHelper.setPhone("");
				showDialog(2);
			}
			
		}
    	
    	
    }
    
    @Override
	public Dialog onCreateDialog(int id) {
		switch(id){
		case 0:
			progressDialog = new ProgressDialog(this);
			progressDialog.setMessage("please wait...");
			progressDialog.setIndeterminate(true);

			return progressDialog;
		case 1:
			ab = new AlertDialog.Builder(this);
			ab.setTitle("계정 설정");
			ab.setMessage("설정 완료");
			ab.setPositiveButton("확인", new android.content.DialogInterface.OnClickListener() {
				
				public void onClick(DialogInterface dialog, int which) {
					// TODO Auto-generated method stub
					//dialog.dismiss();
				}
			});
			return ab.create();
		case 2:
			ab = new AlertDialog.Builder(this);
			ab.setTitle("설정 실패");
			ab.setMessage("입력값을 다시 확인해 주세요");
			ab.setPositiveButton("확인", new android.content.DialogInterface.OnClickListener() {
				
				public void onClick(DialogInterface dialog, int which) {
					// TODO Auto-generated method stub
					//dialog.dismiss();
					Log.e("ERROR","here");
				}
			});
			return ab.create();
		default:
			return null;
		}
	}
}
